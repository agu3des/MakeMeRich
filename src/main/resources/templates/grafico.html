<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/principal}" 
      th:with="titulo='Resumo de Contas'">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div layout:fragment="conteudo" class="container py-4">

      <div th:if="${conta != null}">
        <h2 class="mb-4 text-success">Resumo da Conta - <span th:text="${conta.numero}"></span></h2>

        <!-- Filtro por ano -->
        <form method="get" th:action="@{/grafico/{idConta}(idConta=${conta.id})}" class="d-flex align-items-center gap-2 mb-4">
        <label for="ano" class="form-label mb-0 me-2 text-success fw-semibold">Ano:</label>
        <select id="ano" name="ano" class="form-select form-select-sm" style="width: 100px;">
          <option th:each="ano : ${anosDisponiveis}"
                  th:value="${ano}" 
                  th:text="${ano}" 
                  th:selected="${ano == anoSelecionado}">
          </option>
        </select>
        <button type="submit" class="btn btn-outline-success btn-sm d-flex align-items-center gap-1">
          <i class="bi bi-bar-chart-line"></i> Atualizar
        </button>
      </form>

      <!-- Gráfico combinado -->
      <div th:if="${conta != null}" class="card border-success shadow-sm mb-4">
        <div class="card-header bg-success text-white fw-bold">
          Evolução Mensal: Total e Qtd. de Transações
        </div>
        <div class="card-body">
          <canvas id="grafico" height="100"></canvas>
        </div>
      </div>

      <script th:inline="javascript">
        const labels = /*[[${labels}]]*/ [];
        const valores = /*[[${valores}]]*/ []; // Totais mensais (R$)
        const qtdTransacoes = /*[[${qtdTransacoes}]]*/ []; // Qtd de transações por mês

        const ctx = document.getElementById('grafico').getContext('2d');
        new Chart(ctx, {
          data: {
            labels: labels,
            datasets: [
              {
                type: 'bar',
                label: 'Qtd. de Transações',
                data: qtdTransacoes,
                backgroundColor: 'rgba(25, 135, 84, 0.5)',
                borderColor: 'rgba(25, 135, 84, 1)',
                borderWidth: 1,
                yAxisID: 'yTransacoes'
              },
              {
                type: 'line',
                label: 'Total Mensal (R$)',
                data: valores,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.4,
                fill: false,
                yAxisID: 'yValores'
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    if (context.dataset.label.includes('Total')) {
                      return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2);
                    }
                    return context.dataset.label + ': ' + context.parsed.y;
                  }
                }
              }
            },
            scales: {
              yTransacoes: {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                title: { display: true, text: 'Qtd. de Transações' }
              },
              yValores: {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                title: { display: true, text: 'Total (R$)' },
                ticks: {
                  callback: function(value) {
                    return 'R$ ' + value.toFixed(2);
                  }
                },
                grid: {
                  drawOnChartArea: false // para não sobrepor as grades
                }
              }
            }
          }
        });
      </script>

      <!-- Botão voltar -->
      <div class="mt-3">
        <a th:href="@{/contas}" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> 
        </a>
      </div>

    </div>
  </body>
</html>
